<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Bowl Console - Moderator Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: #fafafa;
            color: #2d3748;
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
            line-height: 1.4;
        }
        
        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
        }
        
        .header-status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: #718096;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #e53e3e;
        }
        
        .status-dot.connected {
            background: #38a169;
        }
        
        .close-btn {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
        }
        
        .close-btn:hover {
            background: #edf2f7;
        }
        
        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: calc(100vh - 45px);
            gap: 1px;
            background: #e2e8f0;
        }
        
        /* Settings Panel */
        .settings-panel {
            background: white;
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 1px;
        }
        
        /* Arduino & Timer Row */
        .top-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #e2e8f0;
        }
        
        /* Section Base Styles */
        .section {
            background: white;
            padding: 16px;
        }
        
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Arduino Section */
        .arduino-section {
            border-right: 1px solid #e2e8f0;
        }
        
        .connection-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .port-select {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            font-size: 12px;
            background: white;
        }
        
        .connect-btn {
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .connect-btn:hover {
            background: #3182ce;
        }
        
        /* Timer Section */
        .timer-display {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            font-family: 'SF Mono', monospace;
            color: #2d3748;
            margin-bottom: 12px;
            line-height: 1;
        }
        
        .timer-controls {
            display: grid;
            grid-template-columns: 60px 1fr 60px;
            gap: 6px;
            align-items: center;
        }
        
        .timer-input {
            padding: 4px 6px;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            text-align: center;
            font-size: 11px;
        }
        
        .timer-btn {
            background: #68d391;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .timer-btn:hover {
            background: #48bb78;
        }
        
        .timer-btn.stop {
            background: #fc8181;
        }
        
        .timer-btn.stop:hover {
            background: #f56565;
        }
        
        /* Question Set Section - Improved */
        .question-section {
            border-bottom: 1px solid #e2e8f0;
            padding: 20px;
            background: white;
        }
        
        .question-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .question-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .question-label {
            font-size: 11px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .question-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .question-input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            flex: 1;
        }
        
        .question-input:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
            outline: none;
        }
        
        .challenge-section {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .challenge-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .challenge-title {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .challenge-toggle {
            background: #e2e8f0;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.2s ease;
        }
        
        .challenge-toggle.active {
            background: #f6ad55;
            color: white;
            box-shadow: 0 2px 4px rgba(246, 173, 85, 0.3);
        }
        
        .challenge-description {
            font-size: 10px;
            color: #718096;
            line-height: 1.4;
        }
        
        .subjects-section {
            margin-top: 16px;
        }
        
        .subjects-label {
            font-size: 11px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .subjects-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .subject-btn {
            background: #edf2f7;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .subject-btn:hover {
            background: #e2e8f0;
            border-color: #cbd5e0;
        }
        
        .subject-btn.active {
            background: #4299e1;
            color: white;
            border-color: #3182ce;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }
        
        /* Teams Section */
        .teams-section {
            overflow-y: auto;
            padding: 16px;
        }
        
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .team-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .team-name-input {
            font-size: 12px;
            font-weight: 600;
            border: none;
            background: transparent;
            color: #2d3748;
            flex: 1;
            margin-right: 8px;
        }
        
        .team-score {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            min-width: 40px;
            text-align: center;
        }
        
        .team-controls {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .score-btn {
            flex: 1;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .score-btn.plus {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .score-btn.minus {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .score-btn.reset {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .team-color {
            margin-bottom: 8px;
        }
        
        .color-label {
            font-size: 10px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        
        .color-option {
            position: relative;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            background: #f7fafc;
        }
        
        .color-option:hover {
            border-color: #cbd5e0;
            transform: scale(1.05);
        }
        
        .color-option.selected {
            border-color: #4299e1;
            background: #ebf8ff;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.2);
        }
        
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin: 0 auto 4px auto;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .color-name {
            font-size: 9px;
            font-weight: 500;
            color: #4a5568;
            text-align: center;
            text-transform: capitalize;
        }
        
        .color-option.selected .color-name {
            color: #3182ce;
            font-weight: 600;
        }
        
        /* Action Cards */
        .action-cards {
            display: flex;
            gap: 4px;
        }
        
        .action-card {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .action-card.angel {
            background: #3182ce;
            color: white;
        }
        
        .action-card.angel.used {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }
        
        .action-card.devil {
            background: #e53e3e;
            color: white;
        }
        
        .action-card.devil.used {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }
        
        .action-card.cross {
            background: #e2e8f0;
            color: #a0aec0;
        }
        
        .action-card.cross.active {
            background: #805ad5;
            color: white;
        }
        
        /* Logs Panel */
        .logs-panel {
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        .logs-header {
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 12px;
            color: #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logs-controls {
            display: flex;
            gap: 6px;
        }
        
        .log-btn {
            background: #edf2f7;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            color: #4a5568;
        }
        
        .log-btn:hover {
            background: #e2e8f0;
        }
        
        .logs-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: white;
            font-family: 'SF Mono', monospace;
            font-size: 11px;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-entry.success {
            background: #f0fff4;
            border-left: 3px solid #38a169;
        }
        
        .log-entry.error {
            background: #fffaf0;
            border-left: 3px solid #e53e3e;
        }
        
        .log-entry.warning {
            background: #fffbf0;
            border-left: 3px solid #d69e2e;
        }
        
        .log-content {
            flex: 1;
        }
        
        .log-timestamp {
            color: #718096;
            font-size: 10px;
            margin-right: 8px;
        }
        
        .log-message {
            color: #2d3748;
        }
        
        .undo-btn {
            background: #fed7d7;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 9px;
            font-weight: 500;
            cursor: pointer;
            color: #742a2a;
            margin-left: 8px;
        }
        
        .undo-btn:hover {
            background: #fc8181;
            color: white;
        }
        
        .undo-btn:disabled {
            background: #f7fafc;
            color: #a0aec0;
            cursor: not-allowed;
        }
        
        /* Quick Actions */
        .quick-actions {
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 16px;
            display: flex;
            gap: 8px;
        }
        
        .quick-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            color: #4a5568;
        }
        
        .quick-btn:hover {
            background: #edf2f7;
        }
        
        .quick-btn.primary {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        
        .quick-btn.primary:hover {
            background: #3182ce;
        }
        
        .quick-btn.danger {
            background: #fc8181;
            color: white;
            border-color: #fc8181;
        }
        
        .quick-btn.danger:hover {
            background: #f56565;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-title">Quiz Bowl Console</div>
        <div class="header-status">
            <div class="status-dot" id="connectionStatus"></div>
            <span id="connectionText">Disconnected</span>
            <button class="close-btn" onclick="window.close()">Close</button>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-btn primary" onclick="startTimer()">Start Timer</button>
        <button class="quick-btn danger" onclick="clearBuzzers()">Clear Buzzers</button>
        <button class="quick-btn" onclick="resetGame()">Reset Game</button>
        <button class="quick-btn" onclick="exportLogs()">Export Logs</button>
    </div>
    
    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Settings Panel -->
        <div class="settings-panel">
            <!-- Arduino & Timer Row -->
            <div class="top-row">
                <!-- Arduino Section -->
                <div class="section arduino-section">
                    <div class="section-title">Arduino Connection</div>
                    <div class="connection-row">
                        <div class="status-dot" id="arduinoStatus"></div>
                        <span id="arduinoText">Not Connected</span>
                    </div>
                    <div class="connection-row">
                        <select class="port-select" id="portSelect">
                            <option value="">Select Port</option>
                        </select>
                        <button class="connect-btn" onclick="toggleConnection()">Connect</button>
                    </div>
                </div>
                
                <!-- Timer Section -->
                <div class="section">
                    <div class="section-title">Timer Control</div>
                    <div class="timer-display" id="timerDisplayConsole">0:00</div>
                    <div class="timer-controls">
                        <input type="number" class="timer-input" id="timerInput" value="15" min="1" max="300">
                        <div style="display: flex; gap: 4px;">
                            <button class="timer-btn" onclick="startTimer()">Start</button>
                            <button class="timer-btn stop" onclick="stopTimer()">Stop</button>
                            <button class="timer-btn" onclick="resetTimer()">Reset</button>
                        </div>
                        <button class="timer-btn" onclick="setTimer()">Set</button>
                    </div>
                </div>
            </div>
            
            <!-- Question Set Section -->
            <div class="section question-section">
                <div class="section-title">Question Set Management</div>
                
                <div class="question-controls">
                    <div class="question-group">
                        <div class="question-label">Current Set</div>
                        <div class="question-row">
                            <select class="question-input" id="questionSetSelect">
                                <option value="1">Set 1</option>
                                <option value="2">Set 2</option>
                                <option value="3">Set 3</option>
                                <option value="4">Set 4</option>
                                <option value="5">Set 5</option>
                                <option value="6">Set 6</option>
                                <option value="7">Set 7</option>
                                <option value="8">Set 8</option>
                            </select>
                            <select class="question-input" id="questionNumber">
                                <option value="1">Q1</option>
                                <option value="2">Q2</option>
                                <option value="3">Q3</option>
                                <option value="4">Q4</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="question-group">
                        <div class="question-label">Set Title</div>
                        <input type="text" placeholder="Enter set title..." class="question-input" id="questionSetTitle">
                    </div>
                </div>
                
                <div class="challenge-section">
                    <div class="challenge-header">
                        <div class="challenge-title">Challenge Multiplier</div>
                        <button class="challenge-toggle" id="challengeToggle" onclick="toggleChallenge()">2x OFF</button>
                    </div>
                    <div class="challenge-description">
                        When enabled, follow-up questions (Q2-Q4) are worth 2x points but first wrong answer gives -2 and ends the set.
                    </div>
                </div>
                
                <div class="subjects-section">
                    <div class="subjects-label">Subject</div>
                    <div class="subjects-row">
                        <button class="subject-btn" onclick="selectSubject('biology')" data-subject="biology">
                            🧬 Biology
                        </button>
                        <button class="subject-btn" onclick="selectSubject('chemistry')" data-subject="chemistry">
                            ⚗️ Chemistry
                        </button>
                        <button class="subject-btn" onclick="selectSubject('physics')" data-subject="physics">
                            ⚛️ Physics
                        </button>
                        <button class="subject-btn" onclick="selectSubject('general')" data-subject="general">
                            🌍 General
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Teams Section -->
            <div class="section teams-section">
                <div class="section-title">Team Management</div>
                <div class="teams-grid">
                    <!-- Team 1 -->
                    <div class="team-card">
                        <div class="team-header">
                            <input type="text" class="team-name-input" id="teamNameInput-1" value="Team 1" onchange="updateTeamName(1)">
                            <div class="team-score" id="teamScoreConsole-1">0</div>
                        </div>
                        <div class="team-controls">
                            <button class="score-btn plus" onclick="adjustScore(1, 1)">+1</button>
                            <button class="score-btn minus" onclick="adjustScore(1, -1)">-1</button>
                            <button class="score-btn reset" onclick="resetScore(1)">Reset</button>
                        </div>
                        <div class="team-color">
                            <div class="color-label">Team Color</div>
                            <div class="color-grid">
                                <div class="color-option selected" onclick="changeTeamColor(1, 'red')" data-color="red">
                                    <div class="color-dot" style="background: #D71E22;"></div>
                                    <div class="color-name">Red</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(1, 'blue')" data-color="blue">
                                    <div class="color-dot" style="background: #1D3CE9;"></div>
                                    <div class="color-name">Blue</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(1, 'lime')" data-color="lime">
                                    <div class="color-dot" style="background: #5BFE4B;"></div>
                                    <div class="color-name">Lime</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(1, 'orange')" data-color="orange">
                                    <div class="color-dot" style="background: #FF8D1C;"></div>
                                    <div class="color-name">Orange</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(1, 'purple')" data-color="purple">
                                    <div class="color-dot" style="background: #783DD2;"></div>
                                    <div class="color-name">Purple</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(1, 'cyan')" data-color="cyan">
                                    <div class="color-dot" style="background: #44FFF7;"></div>
                                    <div class="color-name">Cyan</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(1, 'pink')" data-color="pink">
                                    <div class="color-dot" style="background: #FF69B4;"></div>
                                    <div class="color-name">Pink</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(1, 'yellow')" data-color="yellow">
                                    <div class="color-dot" style="background: #FFD700;"></div>
                                    <div class="color-name">Yellow</div>
                                </div>
                            </div>
                        </div>
                        <div class="action-cards">
                            <div class="action-card angel" onclick="toggleActionCard(1, 'angel')" id="angelCard-1">ANGEL</div>
                            <div class="action-card devil" onclick="activateDevil(1)" id="devilCard-1">DEVIL</div>
                            <div class="action-card cross" id="crossCard-1">CROSS</div>
                        </div>
                    </div>
                    
                    <!-- Team 2 -->
                    <div class="team-card">
                        <div class="team-header">
                            <input type="text" class="team-name-input" id="teamNameInput-2" value="Team 2" onchange="updateTeamName(2)">
                            <div class="team-score" id="teamScoreConsole-2">0</div>
                        </div>
                        <div class="team-controls">
                            <button class="score-btn plus" onclick="adjustScore(2, 1)">+1</button>
                            <button class="score-btn minus" onclick="adjustScore(2, -1)">-1</button>
                            <button class="score-btn reset" onclick="resetScore(2)">Reset</button>
                        </div>
                        <div class="team-color">
                            <div class="color-label">Team Color</div>
                            <div class="color-grid">
                                <div class="color-option" onclick="changeTeamColor(2, 'red')" data-color="red">
                                    <div class="color-dot" style="background: #D71E22;"></div>
                                    <div class="color-name">Red</div>
                                </div>
                                <div class="color-option selected" onclick="changeTeamColor(2, 'blue')" data-color="blue">
                                    <div class="color-dot" style="background: #1D3CE9;"></div>
                                    <div class="color-name">Blue</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(2, 'lime')" data-color="lime">
                                    <div class="color-dot" style="background: #5BFE4B;"></div>
                                    <div class="color-name">Lime</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(2, 'orange')" data-color="orange">
                                    <div class="color-dot" style="background: #FF8D1C;"></div>
                                    <div class="color-name">Orange</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(2, 'purple')" data-color="purple">
                                    <div class="color-dot" style="background: #783DD2;"></div>
                                    <div class="color-name">Purple</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(2, 'cyan')" data-color="cyan">
                                    <div class="color-dot" style="background: #44FFF7;"></div>
                                    <div class="color-name">Cyan</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(2, 'pink')" data-color="pink">
                                    <div class="color-dot" style="background: #FF69B4;"></div>
                                    <div class="color-name">Pink</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(2, 'yellow')" data-color="yellow">
                                    <div class="color-dot" style="background: #FFD700;"></div>
                                    <div class="color-name">Yellow</div>
                                </div>
                            </div>
                        </div>
                        <div class="action-cards">
                            <div class="action-card angel" onclick="toggleActionCard(2, 'angel')" id="angelCard-2">ANGEL</div>
                            <div class="action-card devil" onclick="activateDevil(2)" id="devilCard-2">DEVIL</div>
                            <div class="action-card cross" id="crossCard-2">CROSS</div>
                        </div>
                    </div>
                    
                    <!-- Team 3 -->
                    <div class="team-card">
                        <div class="team-header">
                            <input type="text" class="team-name-input" id="teamNameInput-3" value="Team 3" onchange="updateTeamName(3)">
                            <div class="team-score" id="teamScoreConsole-3">0</div>
                        </div>
                        <div class="team-controls">
                            <button class="score-btn plus" onclick="adjustScore(3, 1)">+1</button>
                            <button class="score-btn minus" onclick="adjustScore(3, -1)">-1</button>
                            <button class="score-btn reset" onclick="resetScore(3)">Reset</button>
                        </div>
                        <div class="team-color">
                            <div class="color-label">Team Color</div>
                            <div class="color-grid">
                                <div class="color-option" onclick="changeTeamColor(3, 'red')" data-color="red">
                                    <div class="color-dot" style="background: #D71E22;"></div>
                                    <div class="color-name">Red</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(3, 'blue')" data-color="blue">
                                    <div class="color-dot" style="background: #1D3CE9;"></div>
                                    <div class="color-name">Blue</div>
                                </div>
                                <div class="color-option selected" onclick="changeTeamColor(3, 'lime')" data-color="lime">
                                    <div class="color-dot" style="background: #5BFE4B;"></div>
                                    <div class="color-name">Lime</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(3, 'orange')" data-color="orange">
                                    <div class="color-dot" style="background: #FF8D1C;"></div>
                                    <div class="color-name">Orange</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(3, 'purple')" data-color="purple">
                                    <div class="color-dot" style="background: #783DD2;"></div>
                                    <div class="color-name">Purple</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(3, 'cyan')" data-color="cyan">
                                    <div class="color-dot" style="background: #44FFF7;"></div>
                                    <div class="color-name">Cyan</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(3, 'pink')" data-color="pink">
                                    <div class="color-dot" style="background: #FF69B4;"></div>
                                    <div class="color-name">Pink</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(3, 'yellow')" data-color="yellow">
                                    <div class="color-dot" style="background: #FFD700;"></div>
                                    <div class="color-name">Yellow</div>
                                </div>
                            </div>
                        </div>
                        <div class="action-cards">
                            <div class="action-card angel" onclick="toggleActionCard(3, 'angel')" id="angelCard-3">ANGEL</div>
                            <div class="action-card devil" onclick="activateDevil(3)" id="devilCard-3">DEVIL</div>
                            <div class="action-card cross" id="crossCard-3">CROSS</div>
                        </div>
                    </div>
                    
                    <!-- Team 4 -->
                    <div class="team-card">
                        <div class="team-header">
                            <input type="text" class="team-name-input" id="teamNameInput-4" value="Team 4" onchange="updateTeamName(4)">
                            <div class="team-score" id="teamScoreConsole-4">0</div>
                        </div>
                        <div class="team-controls">
                            <button class="score-btn plus" onclick="adjustScore(4, 1)">+1</button>
                            <button class="score-btn minus" onclick="adjustScore(4, -1)">-1</button>
                            <button class="score-btn reset" onclick="resetScore(4)">Reset</button>
                        </div>
                        <div class="team-color">
                            <div class="color-label">Team Color</div>
                            <div class="color-grid">
                                <div class="color-option" onclick="changeTeamColor(4, 'red')" data-color="red">
                                    <div class="color-dot" style="background: #D71E22;"></div>
                                    <div class="color-name">Red</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(4, 'blue')" data-color="blue">
                                    <div class="color-dot" style="background: #1D3CE9;"></div>
                                    <div class="color-name">Blue</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(4, 'lime')" data-color="lime">
                                    <div class="color-dot" style="background: #5BFE4B;"></div>
                                    <div class="color-name">Lime</div>
                                </div>
                                <div class="color-option selected" onclick="changeTeamColor(4, 'orange')" data-color="orange">
                                    <div class="color-dot" style="background: #FF8D1C;"></div>
                                    <div class="color-name">Orange</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(4, 'purple')" data-color="purple">
                                    <div class="color-dot" style="background: #783DD2;"></div>
                                    <div class="color-name">Purple</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(4, 'cyan')" data-color="cyan">
                                    <div class="color-dot" style="background: #44FFF7;"></div>
                                    <div class="color-name">Cyan</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(4, 'pink')" data-color="pink">
                                    <div class="color-dot" style="background: #FF69B4;"></div>
                                    <div class="color-name">Pink</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(4, 'yellow')" data-color="yellow">
                                    <div class="color-dot" style="background: #FFD700;"></div>
                                    <div class="color-name">Yellow</div>
                                </div>
                            </div>
                        </div>
                        <div class="action-cards">
                            <div class="action-card angel" onclick="toggleActionCard(4, 'angel')" id="angelCard-4">ANGEL</div>
                            <div class="action-card devil" onclick="activateDevil(4)" id="devilCard-4">DEVIL</div>
                            <div class="action-card cross" id="crossCard-4">CROSS</div>
                        </div>
                    </div>
                    
                    <!-- Team 5 -->
                    <div class="team-card">
                        <div class="team-header">
                            <input type="text" class="team-name-input" id="teamNameInput-5" value="Team 5" onchange="updateTeamName(5)">
                            <div class="team-score" id="teamScoreConsole-5">0</div>
                        </div>
                        <div class="team-controls">
                            <button class="score-btn plus" onclick="adjustScore(5, 1)">+1</button>
                            <button class="score-btn minus" onclick="adjustScore(5, -1)">-1</button>
                            <button class="score-btn reset" onclick="resetScore(5)">Reset</button>
                        </div>
                        <div class="team-color">
                            <div class="color-label">Team Color</div>
                            <div class="color-grid">
                                <div class="color-option" onclick="changeTeamColor(5, 'red')" data-color="red">
                                    <div class="color-dot" style="background: #D71E22;"></div>
                                    <div class="color-name">Red</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(5, 'blue')" data-color="blue">
                                    <div class="color-dot" style="background: #1D3CE9;"></div>
                                    <div class="color-name">Blue</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(5, 'lime')" data-color="lime">
                                    <div class="color-dot" style="background: #5BFE4B;"></div>
                                    <div class="color-name">Lime</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(5, 'orange')" data-color="orange">
                                    <div class="color-dot" style="background: #FF8D1C;"></div>
                                    <div class="color-name">Orange</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(5, 'purple')" data-color="purple">
                                    <div class="color-dot" style="background: #783DD2;"></div>
                                    <div class="color-name">Purple</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(5, 'cyan')" data-color="cyan">
                                    <div class="color-dot" style="background: #44FFF7;"></div>
                                    <div class="color-name">Cyan</div>
                                </div>
                                <div class="color-option selected" onclick="changeTeamColor(5, 'pink')" data-color="pink">
                                    <div class="color-dot" style="background: #FF69B4;"></div>
                                    <div class="color-name">Pink</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(5, 'yellow')" data-color="yellow">
                                    <div class="color-dot" style="background: #FFD700;"></div>
                                    <div class="color-name">Yellow</div>
                                </div>
                            </div>
                        </div>
                        <div class="action-cards">
                            <div class="action-card angel" onclick="toggleActionCard(5, 'angel')" id="angelCard-5">ANGEL</div>
                            <div class="action-card devil" onclick="activateDevil(5)" id="devilCard-5">DEVIL</div>
                            <div class="action-card cross" id="crossCard-5">CROSS</div>
                        </div>
                    </div>
                    
                    <!-- Team 6 -->
                    <div class="team-card">
                        <div class="team-header">
                            <input type="text" class="team-name-input" id="teamNameInput-6" value="Team 6" onchange="updateTeamName(6)">
                            <div class="team-score" id="teamScoreConsole-6">0</div>
                        </div>
                        <div class="team-controls">
                            <button class="score-btn plus" onclick="adjustScore(6, 1)">+1</button>
                            <button class="score-btn minus" onclick="adjustScore(6, -1)">-1</button>
                            <button class="score-btn reset" onclick="resetScore(6)">Reset</button>
                        </div>
                        <div class="team-color">
                            <div class="color-label">Team Color</div>
                            <div class="color-grid">
                                <div class="color-option" onclick="changeTeamColor(6, 'red')" data-color="red">
                                    <div class="color-dot" style="background: #D71E22;"></div>
                                    <div class="color-name">Red</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(6, 'blue')" data-color="blue">
                                    <div class="color-dot" style="background: #1D3CE9;"></div>
                                    <div class="color-name">Blue</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(6, 'lime')" data-color="lime">
                                    <div class="color-dot" style="background: #5BFE4B;"></div>
                                    <div class="color-name">Lime</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(6, 'orange')" data-color="orange">
                                    <div class="color-dot" style="background: #FF8D1C;"></div>
                                    <div class="color-name">Orange</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(6, 'purple')" data-color="purple">
                                    <div class="color-dot" style="background: #783DD2;"></div>
                                    <div class="color-name">Purple</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(6, 'cyan')" data-color="cyan">
                                    <div class="color-dot" style="background: #44FFF7;"></div>
                                    <div class="color-name">Cyan</div>
                                </div>
                                <div class="color-option" onclick="changeTeamColor(6, 'pink')" data-color="pink">
                                    <div class="color-dot" style="background: #FF69B4;"></div>
                                    <div class="color-name">Pink</div>
                                </div>
                                <div class="color-option selected" onclick="changeTeamColor(6, 'yellow')" data-color="yellow">
                                    <div class="color-dot" style="background: #FFD700;"></div>
                                    <div class="color-name">Yellow</div>
                                </div>
                            </div>
                        </div>
                        <div class="action-cards">
                            <div class="action-card angel" onclick="toggleActionCard(6, 'angel')" id="angelCard-6">ANGEL</div>
                            <div class="action-card devil" onclick="activateDevil(6)" id="devilCard-6">DEVIL</div>
                            <div class="action-card cross" id="crossCard-6">CROSS</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Logs Panel -->
        <div class="logs-panel">
            <div class="logs-header">
                System Logs
                <div class="logs-controls">
                    <button class="log-btn" onclick="clearLogs()">Clear</button>
                    <button class="log-btn" onclick="exportLogs()">Export</button>
                </div>
            </div>
            <div class="logs-content" id="logsContent">
                <div class="log-entry">
                    <div class="log-content">
                        <span class="log-timestamp">[00:00:00]</span>
                        <span class="log-message">Console initialized - Ready for moderation</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state management
        const gameState = {
            teams: {
                1: { name: 'Team 1', score: 0, color: 'red', cards: { angel: false, devil: false, cross: false, angelUsed: false, devilUsed: false } },
                2: { name: 'Team 2', score: 0, color: 'blue', cards: { angel: false, devil: false, cross: false, angelUsed: false, devilUsed: false } },
                3: { name: 'Team 3', score: 0, color: 'lime', cards: { angel: false, devil: false, cross: false, angelUsed: false, devilUsed: false } },
                4: { name: 'Team 4', score: 0, color: 'orange', cards: { angel: false, devil: false, cross: false, angelUsed: false, devilUsed: false } },
                5: { name: 'Team 5', score: 0, color: 'pink', cards: { angel: false, devil: false, cross: false, angelUsed: false, devilUsed: false } },
                6: { name: 'Team 6', score: 0, color: 'yellow', cards: { angel: false, devil: false, cross: false, angelUsed: false, devilUsed: false } }
            },
            currentQuestionSet: 1,
            currentQuestionNumber: 1,
            timerValue: 15,
            timerRunning: false,
            challenge2x: false,
            currentSubject: null,
            actionHistory: [], // For undo functionality
            availableColors: ['red', 'blue', 'lime', 'orange', 'purple', 'cyan', 'pink', 'yellow']
        };

        // Initialize Socket.IO connection
        const socket = io();

        // Action cards functionality
        function toggleActionCard(teamId, cardType) {
            if (cardType === 'angel') {
                if (gameState.teams[teamId].cards.angelUsed) {
                    addLog(`Team ${teamId} angel card already used`, 'warning');
                    return;
                }
                
                const isActive = gameState.teams[teamId].cards.angel;
                gameState.teams[teamId].cards.angel = !isActive;
                
                const angelCard = document.getElementById(`angelCard-${teamId}`);
                if (gameState.teams[teamId].cards.angel) {
                    addLog(`Team ${teamId} angel card activated`, 'success');
                } else {
                    addLog(`Team ${teamId} angel card deactivated`);
                }
                
                socket.emit('card_update', {
                    teamId: teamId,
                    cardType: cardType,
                    active: gameState.teams[teamId].cards.angel
                });
            }
        }

        function activateDevil(teamId) {
            if (gameState.teams[teamId].cards.devilUsed) {
                addLog(`Team ${teamId} devil card already used`, 'warning');
                return;
            }
            
            // Show team selection dialog for devil attack
            const teams = Object.keys(gameState.teams).filter(id => id != teamId);
            const teamNames = teams.map(id => `${id}: ${gameState.teams[id].name}`).join('\n');
            const targetTeam = prompt(`Team ${teamId} Devil Attack!\nSelect target team:\n${teamNames}\n\nEnter team number:`);
            
            if (targetTeam && teams.includes(targetTeam)) {
                const targetTeamId = parseInt(targetTeam);
                
                // Check if target has cross protection
                if (gameState.teams[targetTeamId].cards.cross) {
                    addLog(`Team ${targetTeamId} protected by cross card - devil attack blocked`, 'warning');
                    return;
                }
                
                // Mark devil card as used
                gameState.teams[teamId].cards.devilUsed = true;
                const devilCard = document.getElementById(`devilCard-${teamId}`);
                devilCard.classList.add('used');
                
                // Apply devil attack (penalty to target team)
                gameState.teams[targetTeamId].score = Math.max(0, gameState.teams[targetTeamId].score - 1);
                document.getElementById(`teamScoreConsole-${targetTeamId}`).textContent = gameState.teams[targetTeamId].score;
                
                // Activate cross protection for target team
                gameState.teams[targetTeamId].cards.cross = true;
                const crossCard = document.getElementById(`crossCard-${targetTeamId}`);
                crossCard.classList.add('active');
                
                addLog(`Team ${teamId} devil attacked Team ${targetTeamId} (-1 point, cross activated)`, 'error', {
                    type: 'devil_attack',
                    attackerId: teamId,
                    targetId: targetTeamId,
                    scoreChange: -1
                });
                
                socket.emit('devil_attack', {
                    attackerId: teamId,
                    targetId: targetTeamId,
                    newScore: gameState.teams[targetTeamId].score
                });
            }
        }

        // Team management functions
        function updateTeamName(teamId) {
            const name = document.getElementById(`teamNameInput-${teamId}`).value;
            const oldName = gameState.teams[teamId].name;
            gameState.teams[teamId].name = name;
            
            socket.emit('team_update', {
                teamId: teamId,
                updates: { name: name }
            });
            
            addLog(`Team ${teamId} name: "${oldName}" → "${name}"`, 'info', {
                type: 'name_change',
                teamId: teamId,
                oldName: oldName,
                newName: name
            });
        }

        function adjustScore(teamId, adjustment) {
            let multiplier = 1;
            if (gameState.challenge2x && adjustment > 0) {
                multiplier = 2;
            }
            
            const actualAdjustment = adjustment * multiplier;
            const oldScore = gameState.teams[teamId].score;
            
            // Check angel protection for negative adjustments
            if (adjustment < 0 && gameState.teams[teamId].cards.angel) {
                // Use angel protection
                gameState.teams[teamId].cards.angel = false;
                gameState.teams[teamId].cards.angelUsed = true;
                
                const angelCard = document.getElementById(`angelCard-${teamId}`);
                angelCard.classList.remove('active');
                angelCard.classList.add('used');
                
                addLog(`Team ${teamId} angel protection used - no penalty applied`, 'success', {
                    type: 'angel_protection',
                    teamId: teamId
                });
                
                socket.emit('card_update', {
                    teamId: teamId,
                    cardType: 'angel',
                    used: true
                });
                return;
            }
            
            gameState.teams[teamId].score = Math.max(0, gameState.teams[teamId].score + actualAdjustment);
            document.getElementById(`teamScoreConsole-${teamId}`).textContent = gameState.teams[teamId].score;
            
            socket.emit('score_update', {
                teamId: teamId,
                score: gameState.teams[teamId].score,
                adjustment: actualAdjustment,
                correct: adjustment > 0
            });
            
            const actionText = adjustment > 0 ? 'correct' : 'incorrect';
            const challengeText = multiplier > 1 ? ' (2x)' : '';
            addLog(`Team ${teamId} ${actionText}: ${oldScore} → ${gameState.teams[teamId].score}${challengeText}`, 
                   adjustment > 0 ? 'success' : 'error', {
                type: 'score_change',
                teamId: teamId,
                oldScore: oldScore,
                newScore: gameState.teams[teamId].score,
                adjustment: actualAdjustment
            });
        }

        function resetScore(teamId) {
            const oldScore = gameState.teams[teamId].score;
            gameState.teams[teamId].score = 0;
            document.getElementById(`teamScoreConsole-${teamId}`).textContent = '0';
            
            socket.emit('score_update', {
                teamId: teamId,
                score: 0,
                adjustment: 0,
                reset: true
            });
            
            addLog(`Team ${teamId} score reset: ${oldScore} → 0`, 'info', {
                type: 'score_reset',
                teamId: teamId,
                oldScore: oldScore
            });
        }

        function changeTeamColor(teamId, color) {
            // Check if color is already used by another team
            const usedByTeam = Object.keys(gameState.teams).find(id => 
                id != teamId && gameState.teams[id].color === color
            );
            
            if (usedByTeam) {
                addLog(`Color ${color} is already used by Team ${usedByTeam}`, 'warning');
                return;
            }
            
            const oldColor = gameState.teams[teamId].color;
            gameState.teams[teamId].color = color;
            
            // Update color selection UI
            const teamCard = document.getElementById(`teamNameInput-${teamId}`).closest('.team-card');
            const colorOptions = teamCard.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.color === color) {
                    option.classList.add('selected');
                }
            });
            
            socket.emit('team_update', {
                teamId: teamId,
                updates: { color: color }
            });
            
            // Update character animation on main display
            socket.emit('character_update', {
                teamId: teamId,
                color: color
            });
            
            addLog(`Team ${teamId} color: ${oldColor} → ${color}`, 'info', {
                type: 'color_change',
                teamId: teamId,
                oldColor: oldColor,
                newColor: color
            });
        }

        // Timer controls
        function setTimer() {
            const value = parseInt(document.getElementById('timerInput').value);
            if (value > 0) {
                const oldValue = gameState.timerValue;
                gameState.timerValue = value;
                socket.emit('set_timer', { value: value });
                document.getElementById('timerDisplayConsole').textContent = formatTime(value);
                addLog(`Timer set: ${formatTime(oldValue)} → ${formatTime(value)}`, 'info');
            }
        }

        function startTimer() {
            if (!gameState.timerRunning) {
                gameState.timerRunning = true;
                socket.emit('start_timer');
                addLog('Timer started', 'success');
            } else {
                gameState.timerRunning = false;
                socket.emit('pause_timer');
                addLog('Timer paused', 'warning');
            }
        }

        function stopTimer() {
            gameState.timerRunning = false;
            socket.emit('stop_timer');
            addLog('Timer stopped', 'info');
        }

        function resetTimer() {
            gameState.timerRunning = false;
            gameState.timerValue = parseInt(document.getElementById('timerInput').value);
            socket.emit('reset_timer', { value: gameState.timerValue });
            document.getElementById('timerDisplayConsole').textContent = formatTime(gameState.timerValue);
            addLog('Timer reset', 'info');
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Question management
        function toggleChallenge() {
            gameState.challenge2x = !gameState.challenge2x;
            const challengeToggle = document.getElementById('challengeToggle');
            challengeToggle.textContent = gameState.challenge2x ? '2x ON' : '2x OFF';
            challengeToggle.classList.toggle('active', gameState.challenge2x);
            
            socket.emit('challenge_update', { enabled: gameState.challenge2x });
            addLog(`2x Challenge ${gameState.challenge2x ? 'enabled' : 'disabled'}`, 'info');
        }

        function selectSubject(subject) {
            const oldSubject = gameState.currentSubject;
            gameState.currentSubject = subject;
            
            const buttons = document.querySelectorAll('.subject-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-subject="${subject}"]`).classList.add('active');
            
            updateQuestionProgress();
            
            addLog(`Subject: ${oldSubject || 'None'} → ${subject}`, 'info');
        }

        function updateQuestionProgress() {
            const setNumber = parseInt(document.getElementById('questionSetSelect').value);
            const questionNumber = parseInt(document.getElementById('questionNumber').value);
            const title = document.getElementById('questionSetTitle').value;
            
            gameState.currentQuestionSet = setNumber;
            gameState.currentQuestionNumber = questionNumber;
            
            // Calculate progress position (8 sets × 4 questions = 32 total positions)
            const totalPosition = ((setNumber - 1) * 4) + questionNumber;
            const progressPercentage = (totalPosition / 32) * 100;
            
            // Animate Among Us character to run then idle
            socket.emit('progress_update', {
                setNumber: setNumber,
                questionNumber: questionNumber,
                title: title,
                subject: gameState.currentSubject,
                progressPercentage: progressPercentage,
                animateRun: true
            });
            
            addLog(`Progress: Set ${setNumber} Q${questionNumber} (${progressPercentage.toFixed(1)}%)`, 'info');
        }

        // Add event listeners for question set changes
        function initializeQuestionListeners() {
            document.getElementById('questionSetSelect').addEventListener('change', updateQuestionProgress);
            document.getElementById('questionNumber').addEventListener('change', updateQuestionProgress);
            document.getElementById('questionSetTitle').addEventListener('input', updateQuestionProgress);
        }

        // Other functions
        function clearBuzzers() {
            socket.emit('clear_buzzers');
            addLog('All buzzers cleared', 'info');
        }

        function resetGame() {
            if (confirm('Reset entire game? This will clear all scores and action cards.')) {
                Object.keys(gameState.teams).forEach(teamId => {
                    gameState.teams[teamId].score = 0;
                    gameState.teams[teamId].cards = { angel: false, devil: false, cross: false, angelUsed: false, devilUsed: false };
                    document.getElementById(`teamScoreConsole-${teamId}`).textContent = '0';
                    
                    // Reset action card UI
                    const angelCard = document.getElementById(`angelCard-${teamId}`);
                    const devilCard = document.getElementById(`devilCard-${teamId}`);
                    const crossCard = document.getElementById(`crossCard-${teamId}`);
                    
                    angelCard.className = 'action-card angel';
                    devilCard.className = 'action-card devil';
                    crossCard.className = 'action-card cross';
                });
                clearBuzzers();
                resetTimer();
                gameState.actionHistory = [];
                addLog('Game completely reset', 'success');
            }
        }

        function toggleConnection() {
            const port = document.getElementById('portSelect').value;
            if (port) {
                socket.emit('connect_arduino', { port: port });
            } else {
                addLog('Please select a port first', 'error');
            }
        }

        // Logging system with undo functionality
        function addLog(message, type = 'info', undoData = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            let undoButton = '';
            if (undoData) {
                gameState.actionHistory.push(undoData);
                undoButton = `<button class="undo-btn" onclick="undoAction(${gameState.actionHistory.length - 1})">UNDO</button>`;
            }
            
            logEntry.innerHTML = `
                <div class="log-content">
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="log-message">${message}</span>
                </div>
                ${undoButton}
            `;
            
            const logsContent = document.getElementById('logsContent');
            logsContent.appendChild(logEntry);
            logsContent.scrollTop = logsContent.scrollHeight;
        }

        function undoAction(actionIndex) {
            if (actionIndex >= gameState.actionHistory.length) return;
            
            const action = gameState.actionHistory[actionIndex];
            
            switch (action.type) {
                case 'score_change':
                    gameState.teams[action.teamId].score = action.oldScore;
                    document.getElementById(`teamScoreConsole-${action.teamId}`).textContent = action.oldScore;
                    addLog(`Undid score change for Team ${action.teamId}: ${action.newScore} → ${action.oldScore}`, 'warning');
                    break;
                    
                case 'score_reset':
                    gameState.teams[action.teamId].score = action.oldScore;
                    document.getElementById(`teamScoreConsole-${action.teamId}`).textContent = action.oldScore;
                    addLog(`Undid score reset for Team ${action.teamId}: 0 → ${action.oldScore}`, 'warning');
                    break;
                    
                case 'name_change':
                    gameState.teams[action.teamId].name = action.oldName;
                    document.getElementById(`teamNameInput-${action.teamId}`).value = action.oldName;
                    addLog(`Undid name change for Team ${action.teamId}: "${action.newName}" → "${action.oldName}"`, 'warning');
                    break;
                    
                case 'color_change':
                    changeTeamColor(action.teamId, action.oldColor);
                    addLog(`Undid color change for Team ${action.teamId}: ${action.newColor} → ${action.oldColor}`, 'warning');
                    break;
                    
                case 'devil_attack':
                    gameState.teams[action.targetId].score += 1; // Restore the point
                    gameState.teams[action.targetId].cards.cross = false; // Remove cross protection
                    document.getElementById(`teamScoreConsole-${action.targetId}`).textContent = gameState.teams[action.targetId].score;
                    document.getElementById(`crossCard-${action.targetId}`).classList.remove('active');
                    addLog(`Undid devil attack: Team ${action.targetId} restored, cross removed`, 'warning');
                    break;
            }
            
            // Disable the undo button
            const undoButtons = document.querySelectorAll('.undo-btn');
            undoButtons[actionIndex].disabled = true;
            undoButtons[actionIndex].textContent = 'UNDONE';
        }

        function clearLogs() {
            document.getElementById('logsContent').innerHTML = `
                <div class="log-entry">
                    <div class="log-content">
                        <span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>
                        <span class="log-message">Logs cleared</span>
                    </div>
                </div>
            `;
            gameState.actionHistory = [];
        }

        function exportLogs() {
            const logs = document.getElementById('logsContent').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz_logs_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            addLog('Logs exported successfully', 'success');
        }

        // Socket event handlers
        socket.on('team_update', (data) => {
            gameState.teams[data.teamId] = { ...gameState.teams[data.teamId], ...data.updates };
            
            if (data.updates.name) {
                document.getElementById(`teamNameInput-${data.teamId}`).value = data.updates.name;
            }
        });

        socket.on('score_update', (data) => {
            gameState.teams[data.teamId].score = data.score;
            document.getElementById(`teamScoreConsole-${data.teamId}`).textContent = data.score;
        });

        socket.on('timer_update', (data) => {
            gameState.timerValue = data.value;
            gameState.timerRunning = data.running;
            document.getElementById('timerDisplayConsole').textContent = formatTime(data.value);
        });

        socket.on('arduino_connected', (data) => {
            document.getElementById('connectionStatus').classList.add('connected');
            document.getElementById('arduinoStatus').classList.add('connected');
            document.getElementById('connectionText').textContent = 'Connected';
            document.getElementById('arduinoText').textContent = `Port: ${data.port}`;
            addLog(`Arduino connected: ${data.port}`, 'success');
        });

        socket.on('arduino_disconnected', () => {
            document.getElementById('connectionStatus').classList.remove('connected');
            document.getElementById('arduinoStatus').classList.remove('connected');
            document.getElementById('connectionText').textContent = 'Disconnected';
            document.getElementById('arduinoText').textContent = 'Not Connected';
            addLog('Arduino disconnected', 'error');
        });

        socket.on('ports_refreshed', (data) => {
            const select = document.getElementById('portSelect');
            select.innerHTML = '<option value="">Select Port</option>';
            data.ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port.device;
                option.textContent = `${port.device} - ${port.description}`;
                select.appendChild(option);
            });
        });

        socket.on('buzzer_pressed', (data) => {
            addLog(`Team ${data.teamId} buzzed in!`, 'success');
        });

        socket.on('log_update', (data) => {
            addLog(data.message, data.type);
        });

        // Initialize console
        document.addEventListener('DOMContentLoaded', function() {
            // Request ports on load
            socket.emit('refresh_ports');
            
            // Initialize timer display
            document.getElementById('timerDisplayConsole').textContent = formatTime(gameState.timerValue);
            
            // Initialize question listeners
            initializeQuestionListeners();
            
            // Send initial progress state
            updateQuestionProgress();
            
            addLog('Console ready for moderation', 'success');
        });

        console.log('Quiz Bowl Console - Clean Moderator Interface');
    </script>
</body>
</html> 