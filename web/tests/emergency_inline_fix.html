<script src="quick_fix.js"></script>
<script>
console.log('üö® INLINE EMERGENCY FIXES STARTING...');

// IMMEDIATE ACTION CARD RESTORATION
const actionCardCSS = document.createElement('style');
actionCardCSS.textContent = `
    /* EMERGENCY ACTION CARD FIXES */
    .team-card-main {
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 16px !important;
        padding: 20px !important;
        border: 3px solid #e5e5e7 !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
        transition: all 0.3s ease !important;
        backdrop-filter: blur(15px) !important;
        min-height: 140px !important;
    }
    
    .action-cards {
        display: flex !important;
        gap: 12px !important;
        justify-content: center !important;
        align-items: center !important;
        padding: 8px !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1) !important;
    }
    
    .action-card {
        width: 40px !important;
        height: 48px !important;
        background-size: contain !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        border-radius: 8px !important;
        transition: all 0.3s ease !important;
        cursor: pointer !important;
        filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.2)) !important;
    }
    
    .action-card.angel { background-image: url('assets/cards/card-angel.png') !important; }
    .action-card.devil { background-image: url('assets/cards/card-devil.png') !important; }
    .action-card.cross { background-image: url('assets/cards/card-cross.png') !important; }
    
    .action-card:hover { transform: scale(1.15) !important; }
    .action-card.active { border: 2px solid #FFD700 !important; transform: scale(1.05) !important; }
    .action-card.used { opacity: 0.4 !important; filter: grayscale(1) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)) !important; }
    
    /* CHARACTER POSITIONING - ABOVE SKY, ON GROUND */
    .character-container-main {
        position: absolute !important;
        bottom: 35% !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        z-index: 100 !important;
    }
    
    .main-character {
        width: 180px !important;
        height: 180px !important;
        z-index: 101 !important;
    }
    
    /* GROUND STRUCTURE: SKY -> GRASS -> BROWN */
    .sky-area {
        z-index: 1 !important;
        height: 65% !important;
    }
    
    .ground-area {
        position: absolute !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        height: 35% !important;
        background: linear-gradient(180deg, #32CD32 0%, #228B22 60%, #8B4513 100%) !important;
        z-index: 2 !important;
    }
    
    /* QUESTION BLOCKS VISIBILITY */
    .question-blocks-beautiful {
        position: absolute !important;
        bottom: 5% !important;
        left: 0 !important;
        right: 0 !important;
        height: 15% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 20 !important;
    }
    
    .question-block-beautiful {
        width: 50px !important;
        height: 45px !important;
        margin: 0 4px !important;
        background: linear-gradient(145deg, #D2B48C, #CD853F) !important;
        border: 2px solid #8B4513 !important;
        border-radius: 10px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: #654321 !important;
        font-weight: 700 !important;
        font-size: 0.9rem !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
        z-index: 21 !important;
    }
    
    .question-block-beautiful.main-block {
        width: 60px !important;
        height: 55px !important;
        background: linear-gradient(145deg, #FFA500, #FF8C00) !important;
        border-color: #FF4500 !important;
        color: white !important;
        font-size: 1.2rem !important;
    }
    
    .question-block-beautiful.current {
        background: linear-gradient(145deg, #32CD32, #228B22) !important;
        color: white !important;
        transform: scale(1.2) !important;
        box-shadow: 0 0 20px rgba(50, 205, 50, 0.8) !important;
    }
    
    .question-block-beautiful.completed {
        background: linear-gradient(145deg, #98FB98, #90EE90) !important;
        color: #006400 !important;
    }
    
    /* SMART RANK BADGES */
    .rank-badge {
        position: absolute !important;
        top: -20px !important;
        left: -20px !important;
        width: 55px !important;
        height: 55px !important;
        z-index: 40 !important;
        opacity: 0 !important;
        transition: all 0.4s ease !important;
    }
    
    .rank-badge.visible {
        opacity: 1 !important;
        animation: smartRankPulse 3s ease-in-out infinite !important;
    }
    
    @keyframes smartRankPulse {
        0%, 100% { transform: scale(1); filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3)); }
        50% { transform: scale(1.1); filter: drop-shadow(0 8px 16px rgba(255, 215, 0, 0.6)); }
    }
`;
document.head.appendChild(actionCardCSS);

// SMART RANKING SYSTEM - Only top teams, handle ties, max 3
window.updateSmartRankings = function() {
    if (!window.gameState?.teams) return;
    
    const teams = Object.keys(window.gameState.teams).map(teamId => ({
        id: teamId,
        score: window.gameState.teams[teamId].score || 0,
        name: window.gameState.teams[teamId].name || `Team ${teamId}`
    }));
    
    // Sort by score (highest first)
    teams.sort((a, b) => b.score - a.score);
    
    // Get unique scores
    const uniqueScores = [...new Set(teams.map(team => team.score))];
    uniqueScores.sort((a, b) => b - a);
    
    // Clear all rank badges first
    for (let teamId = 1; teamId <= 6; teamId++) {
        const rankBadge = document.getElementById(`rankBadge-${teamId}`);
        if (rankBadge) {
            rankBadge.classList.remove('visible');
        }
    }
    
    // Assign ranks - only to teams with highest scores (max 3 teams, skip zero scores)
    let currentRank = 1;
    let teamsShown = 0;
    
    for (const score of uniqueScores) {
        if (teamsShown >= 3 || score <= 0) break; // Max 3 teams, skip zero scores
        
        const teamsWithThisScore = teams.filter(team => team.score === score);
        
        for (const team of teamsWithThisScore) {
            if (teamsShown >= 3) break;
            
            const rankBadge = document.getElementById(`rankBadge-${team.id}`);
            if (rankBadge) {
                // Determine rank image
                let rankImage;
                if (currentRank === 1) rankImage = 'assets/rankings/ranking-1st.png';
                else if (currentRank === 2) rankImage = 'assets/rankings/ranking-2nd.png';
                else rankImage = 'assets/rankings/ranking-3rd.png';
                
                rankBadge.src = rankImage;
                
                // Animate in with delay
                setTimeout(() => {
                    rankBadge.classList.add('visible');
                }, teamsShown * 200);
                
                console.log(`üèÜ Team ${team.id} (${team.name}): Rank ${currentRank} with score ${score}`);
                teamsShown++;
            }
        }
        
        // Move to next rank (accounting for ties)
        currentRank += teamsWithThisScore.length;
    }
    
    console.log(`‚úÖ Smart ranking complete: ${teamsShown} teams ranked`);
};

// ENHANCED SOCKETIO SYNCHRONIZATION
if (window.socket) {
    // Team updates
    window.socket.off('team_update');
    window.socket.on('team_update', function(data) {
        console.log('üì° Team update received:', data);
        
        if (data.reset) {
            // Handle full reset
            for (let teamId = 1; teamId <= 6; teamId++) {
                if (window.gameState?.teams[teamId]) {
                    window.gameState.teams[teamId].score = 0;
                    window.gameState.teams[teamId].cards = {
                        angel: false, devil: false, cross: false,
                        angelUsed: false, devilUsed: false
                    };
                    if (window.updateTeamDisplay) window.updateTeamDisplay(teamId);
                }
            }
            setTimeout(window.updateSmartRankings, 100);
        } else if (window.gameState?.teams[data.teamId]) {
            // Handle individual team update
            Object.assign(window.gameState.teams[data.teamId], data);
            if (window.updateTeamDisplay) window.updateTeamDisplay(data.teamId);
            setTimeout(window.updateSmartRankings, 100);
        }
    });
    
    // Progress updates
    window.socket.off('progress_update');
    window.socket.on('progress_update', function(data) {
        console.log('üìç Progress update received:', data);
        
        if (window.gameState) {
            window.gameState.currentQuestionSet = data.setNumber;
            window.gameState.currentQuestionNumber = data.questionNumber;
            
            // Update progress display
            if (window.updateBeautifulQuestionBlocks) {
                window.updateBeautifulQuestionBlocks(data.setNumber, data.questionNumber);
            }
            
            // Update question header
            const questionSetElement = document.getElementById('currentQuestionSet');
            if (questionSetElement) {
                questionSetElement.textContent = data.title || `Question Set ${data.setNumber}`;
            }
        }
    });
    
    // Card updates
    window.socket.off('card_update');
    window.socket.on('card_update', function(data) {
        console.log('üé¥ Card update received:', data);
        
        if (window.gameState?.teams[data.teamId] && data.cards) {
            Object.assign(window.gameState.teams[data.teamId].cards, data.cards);
            if (window.updateTeamDisplay) window.updateTeamDisplay(data.teamId);
        }
    });
    
    console.log('‚úÖ Enhanced SocketIO synchronization active');
}

// OVERRIDE updateTeamDisplay to include smart rankings
const originalUpdateTeamDisplay = window.updateTeamDisplay;
if (originalUpdateTeamDisplay) {
    window.updateTeamDisplay = function(teamId) {
        originalUpdateTeamDisplay(teamId);
        setTimeout(window.updateSmartRankings, 100);
    };
}

// INITIALIZE FIXES
setTimeout(() => {
    console.log('üö® Initializing emergency fixes...');
    
    // Initialize smart rankings
    if (window.updateSmartRankings) {
        window.updateSmartRankings();
    }
    
    // Initialize question blocks
    if (window.updateBeautifulQuestionBlocks && window.gameState) {
        window.updateBeautifulQuestionBlocks(
            window.gameState.currentQuestionSet || 1,
            window.gameState.currentQuestionNumber || 1
        );
    }
    
    // Test functions
    window.testEmergencyFixes = function() {
        console.log('üß™ Testing emergency fixes...');
        window.updateSmartRankings();
        if (window.updateBeautifulQuestionBlocks) {
            window.updateBeautifulQuestionBlocks(1, 1);
        }
        console.log('‚úÖ Test complete');
    };
    
    console.log('‚úÖ ALL EMERGENCY FIXES INITIALIZED!');
    console.log('  ‚úÖ Beautiful team card layout with action cards');
    console.log('  ‚úÖ Smart ranking system (top teams only, handles ties, max 3)');
    console.log('  ‚úÖ Character above sky, on ground level');
    console.log('  ‚úÖ Proper ground structure: sky ‚Üí grass ‚Üí brown');
    console.log('  ‚úÖ Question blocks visible in brown area');
    console.log('  ‚úÖ Enhanced SocketIO synchronization');
    console.log('  üß™ Use testEmergencyFixes() to test all systems');
    
}, 1000);

console.log('üö® INLINE EMERGENCY FIXES LOADED!');
</script>
</body>
</html>
